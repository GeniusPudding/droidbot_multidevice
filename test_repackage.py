import os
import subprocess


testdir = "C:\\Users\\user\\Desktop\\testing\\dataset\\runnable_on_android6\\10av_virus" 
test = ['03D98D91D3DAB873BB3CC467F8FED2C6A3832946BFC90CE4106537995F7CB87F.apk', '05B6F908159A4E101025BE352ECC5682259552ED80567C9003F64203D7D3D13C.apk', '095B9EEE5C4D22465540D2522FC6C1EC8A52C852F7DC95409ADEFD6EA80F3BA5.apk', '0A1BBEB6738F2F5878DBD90D1BE4D7E7CE59B52AB4068955F2446B298B56E9C1.apk', '0A3C04C8BC62B81646085B1E5ED8D36B2FBCFD45AF2D66A35BAA728F16E06F7D.apk', '0E8CB955DA332E47E4F03C38ACEA91048CF912CF882234B159C0FD9AE7C19C97.apk', '1200575EC97B204B58F5EE3C0E66200EC1ABA73453D092C1288C8452FC394A16.apk', '13B9ACE61C4E079CB56D3C43B8C6F7EF4B728B254B216E30311B7EB950B3C73C.apk', '142177500E37C5473DE1ED1460CB3495C4E72B161B0B714B5A5D97D5827DB2CC.apk', 
'147542037F6D440027611DED652AAD36B8819C9B12A42D49B78261E879EF9E6A.apk', '19B28F5A99C67FA386E4A2FE2A85E05016F36DC7274FE015406CCE8BD4FB7688.apk', '1DD3765B0036F6865A040F99FEA27B9148E9F5D1B3BA5E24407B665D3B292039.apk', '1EEEBC1D99D4E3F910AAE9900423C7B352A987A7F492C02513578BED23A36653.apk', '1F643E37D1040AF92F6ACA69CD27E0AA980E345826C11E17986F125425E975E3.apk', '218922152B17FBC47094B778B9569455171CD3EBDD4EB3CCE9FE98D7219AA1EC.apk', '231A1B099BFCC222A0647C3AD774863DDC1A1A9ACF28F7600E100C9F93171829.apk', '29A9B07B72809F00F8748198F60CF6CA5412394CA78775A68B87DBB687238355.apk', '2A9DC237B951EECC130EEC5E23252789E4C9B5877125389EC88E37EF778519D0.apk', '3103E5014959ACE0B14426EB32725159418E8F5A28473FA289E3AA61B78FCA51.apk', '312FE755D68D9DCD1268D82A0BF2DC8E03C43407DFC567C67C5FE650173EF5DA.apk', '335455F21F6131BFF83E6E5ECD0DEE8A4FC546CC5DF2EE431B75FF06326900D6.apk', '35D48D1C96C1F148B528A0AC09C2AED60CE5CE076D2E4E0901B226A09D52BA09.apk', '3B0E03F879C03CA9DFB7B969B9C1413566B0F4B4EACAC4039F68719E7535A28C.apk', '3EDBE3BA73ECE734DDE8452EE81183ECCA0882D1B85A72D57D8134B9FE10815B.apk', '45D8357D9DC89050F0AD707E26A3EBA5B9883CFB4C2DDCBD5F6A68524328E25E.apk', '46999193575E1A4FD79A0435E08AB650DC78CF262A6FC7B6A77900627AD7835B.apk', '4708F97523D0B5A2EADA64AF7D1532447C3BD0F855C0AE1846CA052440DD5209.apk', '49E01FEE1893052408A4E6D299F3162028BDF2D229DDFCB2153F6EDFF2255AA4.apk', '49F8450E0C8D70572B8381C07975ACF9E6F375C4B5341ACEF306E6E4C0D1B6BF.apk', '4B33090F1125FC4B1EFB2FFEB313748B3B8DE933BA582CDE522CCAD94FE79854.apk', '4DD7694BE971EFC9554321DAECCD8E2A6ECD64657B3978258049288FBC325E5D.apk', '4F3D9EA642501A87D3A7AE59A27628D151BFDB24FA81E55E586BF2A9BFE88EBE.apk', '502EC7540D4E770ADC28A6246A7AD80758595CAE17B359B50EEB9F61F14008CA.apk', '50BB39C035D2C866ACA164DD2DC736E20EF98F07A2B9E413E5E1DB98EA7205C5.apk', '524AF5682C57F17FF660406E7C0A41E74FE5DC4C8A034E7072932C6DBF520F67.apk', '55FFA199A3F3702F1B799709BABB6C3E7127336FF771CC39AC001C06DEABA2C0.apk', '564FC37E40ECD0EE20091D9C0E2B8A63BB74443501711396EEB6F2387B3D663F.apk', '5760BBA0DAF82BA364A98B6EFD9D3EAC52DDA4DE4E4DC6C2643BF89619476D5E.apk', '5A98AA36AA0717EB5ED4E3981906FDA94AF0B5706A1F3FFE651A2156A9BBEB1F.apk', '5E4DE923263F545BCB38079C4A6589DCCAEA745E67DCAC9717A6961253A7646C.apk', '60C1384F912E3AC72201ADAE9E049364B50AB3DDF72D8A8E11D6D557007E720C.apk', '6110D06FA16CB55ABEFFFE93B115906594964F1762615AD77200D3629FBF0CD6.apk', '649DA0000488DE56BF55D33F42CBB44C6F39210C516DFC16DE64665A97D4F198.apk', '665A0D82131B1D70E87404F939D60A1C63C276169A0710100F658C5F209F9C42.apk', '675224CFA95EB474C5F48FC23C6E12E336979600BD43B03BF6A8D55B13907DB8.apk', '6B0AD7BCF974DA834A045A204754F74B24801F9F7E1E2C289AC88CC573875DBD.apk', '6B88FECE70873C6A6F1ED849F89B40678AC05803A094C59760F895C7B878BD17.apk', '6C93E0C445826FE9C61CB029AEF8C5ADD48A42D069980EE3FD87867AB3EC0675.apk', '7019E24EF3086F2E17034275BCE9BFBBC7291EBBF9EE91FED3C9CFE501D3F21A.apk', '766C9E8A6AA82BF3BD0C9EB9022D770CC1B89AF5142B2B0EDD9A26DA42F13E2C.apk', '7D3B8F04B1810E462FDF5621A0F1EAE40607F0FBFE92E696A82118B5437C28CB.apk', '7E338BF1CF47180B28404FB266B9D303EBD099B8299658B1D2F9699050CC6DA6.apk', '7EA62452A807C6DCF0D53159D0A4524AAEBD80D6847242548507F5B4EEDA8C31.apk', '7F36D953FF533B546167F726FC4248280CCA41DC200F8D0DDC0DF219DF47D959.apk', '7FE60524DCFA7A332988A3F150E6ADDDDAF92C35A70AFD6AD67A306059A4139C.apk', '8458B170B269B0F5D425EAF78C24D8E726AD508B3D79963F5969381D18D1AF8F.apk', '86E1F06ADCDCA1E9497BE79EC41E4DA6476CD2EA6823CF1495BAFBAC4523D143.apk', '8BC5B9A274AE42821F8270EF7AD09CF57A2D73F86D468F16A9868C497220C5DC.apk', '922C8A3972C8A10471456A1CABE3DB5CB1D4F18B06C86C0C035C9E8647BDE354.apk', '93C7713A70B5AC9D4747EF556BA91525CCB29BDE5E85E2940D3B735D0FB95AE9.apk', '94BC479181A2B7F2A9B233EA20E241FABC00AD8600EC0F4E4083675E45FACCCE.apk', '952CA03378567E406FBF659D2E9357E4ABC8557B7DB2331A683C8777AA5246FA.apk', '95CC784FDF0C123FF6AA7B62C9C8E9A5EB8F309B74701B0B7CAFC7896BD05C17.apk', '9B263775BB4B94B1F156E43A031BAC385030AA0111C634457AB23448D9796F14.apk']

#test = ['01419AEC9D115B9053535535164953DC06285A7A306927A2A4B5D4352101F5B1.apk']

if __name__ == "__main__":

    for apk in test:
        target_apk_path = os.path.join(testdir,apk)
        dirname, basename = os.path.split(target_apk_path)
        apkname = os.path.splitext(basename)[0]
        apktool_dir = os.path.join(dirname,apkname)
        try:
            #on win10
            f = os.popen('apktool b '+'\"'+apktool_dir+'\"').read()#.read() for blocking
            print(f'apktool build:{f}')
            # cmd = ['apktool', 'b',apktool_dir]# apktool_dir.rstrip('\\/')]
            # print(f'cmd:{cmd}')
            # r = subprocess.check_output(cmd).decode()
            # print(f'check output:{r}')
            repackage = os.path.join(os.getcwd(), 'apkmaster','batches','repackage.bat')
            cmd = [repackage,dirname,apkname]# apktool_dir.rstrip('\\/')]
            print(f'cmd:{cmd}')
            r = subprocess.check_output(cmd).decode()
            packagename = r.split('\r\n')[-2]
            print(f'check output:{r}')
            #TODO: on Unix
        except Exception as e:
            print(e)
            #raise RuntimeError('Failed to repackage')
        input(f'test:{apk}')    